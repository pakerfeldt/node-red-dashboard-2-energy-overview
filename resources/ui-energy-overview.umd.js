(function(){"use strict";try{if(typeof document<"u"){var e=document.createElement("style");e.appendChild(document.createTextNode(".ui-energy-overview-wrapper[data-v-811c0ea4]{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:transparent}.canvas-wrapper[data-v-811c0ea4]{position:relative;max-width:100%;width:100%;height:100%;margin:0 auto}.canvas-wrapper img[data-v-811c0ea4]{display:block;width:100%;height:auto;max-height:100%;object-fit:contain}.canvas-wrapper svg[data-v-811c0ea4]{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}")),document.head.appendChild(e)}}catch(t){console.error("vite-plugin-css-injected-by-js",t)}})();
(function(E,m){typeof exports=="object"&&typeof module<"u"?m(exports,require("vuex"),require("vue")):typeof define=="function"&&define.amd?define(["exports","vuex","vue"],m):(E=typeof globalThis<"u"?globalThis:E||self,m(E["ui-energy-overview"]={},E.vuex,E.Vue))})(this,function(E,m,p){"use strict";const _=(e,t)=>{const s=e.__vccOpts||e;for(const[r,i]of t)s[r]=i;return s},g="/resources/node-red-dashboard-2-energy-overview/house.webp",v={name:"UIEnergyOverview",inject:["$socket","$dataTracker"],props:{id:{type:String,required:!0},props:{type:Object,default:()=>({})},state:{type:Object,default:()=>({enabled:!1,visible:!1})}},data(){return{mounted:!1,imageLoaded:!1,animationFrameId:null,REF_WIDTH:1056,REF_HEIGHT:992,scaleFactor:1,INACTIVE_ROUTE_COLOR:"#7a7b7e",DEFAULT_PULSE_COLOR:"#4dcbbf",pulses:{},labelLines:{},pulseGroups:{},defaultPulsePathsData:{solarToInverter:"M 427 295 L 484 332 L 484 533",inverterToHome1:"M 513 532 L 513 445 L 808 451 L 810 549",inverterToHome2:"M 513 532 L 513 445 L 966 455",inverterToGrid:"M 451 631 L 401 631 L 403 821 L 449 848",inverterToBattery:"M 499 649 L 499 748 L 594 742",inverterToCar:"M 451 604 L 389 608 L 253 599 L 253 654"},defaultLabelPathsData:{solar:{d:"M 608 41 L 608 300",align:"top",label:"SOLAR"},home:{d:"M 776 41 L 776 445",align:"top",label:"HOME"},grid:{d:"M 448 850 L 448 921",align:"bottom",label:"GRID"},battery:{d:"M 643 772 L 643 921",align:"bottom",label:"BATTERY"},car:{d:"M 103 820 L 103 921",align:"bottom",label:"CAR"}},routes:{solarToInverter:{group:"solar",reverse:!1,opposite:null},inverterToHome:{group:"home",reverse:!1,opposite:null},inverterToGrid:{group:"grid",reverse:!1,opposite:"gridToInverter"},gridToInverter:{group:"grid",reverse:!0,opposite:"inverterToGrid"},inverterToBattery:{group:"battery",reverse:!1,opposite:"batteryToInverter"},batteryToInverter:{group:"battery",reverse:!0,opposite:"inverterToBattery"},inverterToCar:{group:"car",reverse:!1,opposite:"carToInverter"},carToInverter:{group:"car",reverse:!0,opposite:"inverterToCar"}}}},computed:{...m.mapState("data",["messages"]),imageUrl(){return this.getProperty("image")||g},pulseColor(){return this.getProperty("pulseColor")||this.DEFAULT_PULSE_COLOR},BASE_SPEED_PX_PER_SEC(){return this.getProperty("animationSpeed")||150},BASE_FADE_MS(){return this.getProperty("fadeTime")||1600},BASE_TRAIL_LENGTH_PX(){return this.getProperty("trailLength")||120},BASE_TRAIL_SPACING_PX(){return this.getProperty("trailSpacing")||4},BASE_STROKE_WIDTH(){return this.getProperty("strokeWidth")||3.2},BASE_LABEL_STROKE_WIDTH(){return 2},BASE_BLUR_STD_DEV(){return 2},labelFontSizes(){const e={value:42,name:32,sub:32};try{const t=this.getProperty("labelFontSizes");return t?JSON.parse(t):e}catch{return e}},labelSpacing(){const e={textOffset:16,valueLabelGap:8,labelSubGap:10};try{const t=this.getProperty("labelSpacing");return t?JSON.parse(t):e}catch{return e}},SPEED_PX_PER_SEC(){return this.BASE_SPEED_PX_PER_SEC*this.scaleFactor},TRAIL_LENGTH_PX(){return this.BASE_TRAIL_LENGTH_PX*this.scaleFactor},TRAIL_SPACING_PX(){return this.BASE_TRAIL_SPACING_PX*this.scaleFactor},LABEL_VALUE_FONT_SIZE(){return this.labelFontSizes.value*this.scaleFactor},LABEL_NAME_FONT_SIZE(){return this.labelFontSizes.name*this.scaleFactor},LABEL_SUB_FONT_SIZE(){return this.labelFontSizes.sub*this.scaleFactor},LABEL_TEXT_OFFSET_X(){return this.labelSpacing.textOffset*this.scaleFactor},LABEL_VALUE_LABEL_GAP(){return this.labelSpacing.valueLabelGap*this.scaleFactor},LABEL_LABEL_SUB_GAP(){return this.labelSpacing.labelSubGap*this.scaleFactor},STROKE_WIDTH(){return this.BASE_STROKE_WIDTH*this.scaleFactor},LABEL_STROKE_WIDTH(){return this.BASE_LABEL_STROKE_WIDTH*this.scaleFactor},BLUR_STD_DEV(){return this.BASE_BLUR_STD_DEV*this.scaleFactor},TRAIL_MAX_DOTS(){return Math.floor(this.TRAIL_LENGTH_PX/this.TRAIL_SPACING_PX)+1},parsedCustomPaths(){const e=this.getProperty("customPaths");if(!e||e.trim()==="")return null;try{const t=JSON.parse(e);return t.energyPaths&&t.labels?t:(console.warn("[UIEnergyOverview] Custom paths missing required fields (energyPaths, labels), using defaults"),null)}catch(t){return console.warn("[UIEnergyOverview] Invalid custom paths JSON, using defaults:",t.message),null}},pulsePathsData(){const e=this.parsedCustomPaths;if(!e)return this.defaultPulsePathsData;const t={};return Object.entries(e.energyPaths).forEach(([s,r])=>{Array.isArray(r)?r.forEach((i,a)=>{t[`${s}${a+1}`]=i}):s==="inverterToHome"?t.inverterToHome1=r:t[s]=r}),t},labelPathsData(){const e=this.parsedCustomPaths;if(!e)return this.defaultLabelPathsData;const t={};return Object.entries(e.labels).forEach(([s,r])=>{t[s]={d:r.position||r.d,align:r.align||"top",label:r.text||r.label||s.toUpperCase()}}),t}},created(){this.$dataTracker(this.id,this.onInput,this.onLoad,this.onDynamicProperties)},mounted(){this.mounted=!0,this.$nextTick(()=>{this.$refs.baseImage&&this.$refs.baseImage.complete&&this.onImageLoad()})},unmounted(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId)},methods:{onInput(e){if(e){if(this.$store.commit("data/bind",{widgetId:this.id,msg:e}),!this.imageLoaded){this.waitForImageAndHandleMessage(e);return}this.handleMessage(e)}},async waitForImageAndHandleMessage(e){try{await this.ensureImageLoaded(),this.imageLoaded&&this.handleMessage(e)}catch(t){console.error("[UIEnergyOverview] Failed to wait for image load:",t),this.handleMessage(e)}},ensureImageLoaded(){return new Promise((e,t)=>{if(this.imageLoaded){e();return}const s=this.$refs.baseImage;if(!s){t(new Error("Image element not found"));return}if(s.complete){this.onImageLoad(),e();return}const r=setTimeout(()=>{s.removeEventListener("load",i),s.removeEventListener("error",a),t(new Error("Image load timeout"))},5e3),i=()=>{clearTimeout(r),s.removeEventListener("load",i),s.removeEventListener("error",a),this.onImageLoad(),e()},a=()=>{clearTimeout(r),s.removeEventListener("load",i),s.removeEventListener("error",a),t(new Error("Image failed to load"))};s.addEventListener("load",i),s.addEventListener("error",a)})},onLoad(e){e&&this.onInput(e)},onDynamicProperties(e){const t=e.ui_update;t&&(typeof t.pulseColor<"u"&&(this.setDynamicProperties({pulseColor:t.pulseColor}),this.updatePulseColors()),typeof t.image<"u"&&this.setDynamicProperties({image:t.image}))},updatePulseColors(){Object.values(this.pulses).forEach(e=>{e.circles.forEach(t=>{t.setAttribute("fill",this.pulseColor)})}),Object.values(this.labelLines).forEach(e=>{e.subEl&&e.subEl.setAttribute("fill",this.pulseColor)})},onImageLoad(){const e=this.$refs.baseImage,t=this.$refs.overlay;if(!e||!t||this.imageLoaded)return;const s=e.naturalWidth,r=e.naturalHeight,i=s/this.REF_WIDTH,a=r/this.REF_HEIGHT;this.scaleFactor=(i+a)/2,t.setAttribute("viewBox",`0 0 ${s} ${r}`);const u=t.querySelector("#pulseBlur feGaussianBlur");u&&u.setAttribute("stdDeviation",this.BLUR_STD_DEV.toFixed(1)),this.imageLoaded=!0,this.$nextTick(()=>{this.initializePulses(t),this.createLabelLines(t),this.configureGlobalTiming(),this.startAnimationLoop();const h=this.messages&&this.messages[this.id];h&&this.handleMessage(h)})},startAnimationLoop(){const e=t=>{try{this.animatePulsesFrame(t),this.animationFrameId=requestAnimationFrame(e)}catch(s){console.error("[UIEnergyOverview] Animation frame error:",s),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}};this.animationFrameId=requestAnimationFrame(e)},handleMessage(e){const t=e.payload||{},s=t.routes||{},r=t.labels||{};Object.keys(this.routes).forEach(i=>{s[i]===!0?this.activateRoute(i):s[i]===!1&&this.deactivateRoute(i)}),Object.keys(r).forEach(i=>{const a=r[i];a.value!==void 0&&this.setLineValue(i,a.value),a.sublabel!==void 0&&this.setLineSubLabel(i,a.sublabel)})},activateRoute(e){const t=this.routes[e];if(!t)return;t.opposite&&this.deactivateRoute(t.opposite);const s=this.pulseGroups[t.group];if(!s)return;const r=performance.now();s.forEach(i=>{i.reverse=t.reverse,i.active=!0,i.cycleStart=r,i.globalAlpha=1})},deactivateRoute(e){const t=this.routes[e];if(!t)return;const s=this.pulseGroups[t.group];s&&s.forEach(r=>{r.active=!1,r.cycleStart=null,r.circles.forEach(i=>i.setAttribute("visibility","hidden"))})},scalePath(e){return e.replace(/(-?\d+\.?\d*)/g,t=>(parseFloat(t)*this.scaleFactor).toFixed(1))},initializePulses(e){const t="http://www.w3.org/2000/svg";Object.entries(this.pulsePathsData).forEach(([r,i])=>{const a=document.createElementNS(t,"path");a.setAttribute("d",this.scalePath(i)),a.setAttribute("stroke",this.INACTIVE_ROUTE_COLOR),a.setAttribute("stroke-opacity","0.6"),a.setAttribute("stroke-width",this.STROKE_WIDTH.toFixed(1)),a.setAttribute("fill","none"),e.appendChild(a),this.pulses[r]=this.createPulseForPath(a,e,t)}),this.pulseGroups.solar=[this.pulses.solarToInverter].filter(Boolean);const s=Object.keys(this.pulses).filter(r=>r.startsWith("inverterToHome")).map(r=>this.pulses[r]).filter(Boolean);this.pulseGroups.home=s.length>0?s:[],this.pulseGroups.grid=[this.pulses.inverterToGrid].filter(Boolean),this.pulseGroups.battery=[this.pulses.inverterToBattery].filter(Boolean),this.pulseGroups.car=[this.pulses.inverterToCar].filter(Boolean)},createPulseForPath(e,t,s){const r=e.getTotalLength(),i=document.createElementNS(s,"g");i.setAttribute("filter","url(#pulseBlur)"),t.appendChild(i);const a=Math.floor(r/this.TRAIL_SPACING_PX)+1,u=Math.min(this.TRAIL_MAX_DOTS,a),h=[];for(let d=0;d<u;d++){const o=document.createElementNS(s,"circle");o.setAttribute("r",(this.STROKE_WIDTH*1.1).toFixed(1)),o.setAttribute("fill",this.pulseColor),o.setAttribute("fill-opacity","0"),o.setAttribute("visibility","hidden"),i.appendChild(o),h.push(o)}const l=this.SPEED_PX_PER_SEC,b=r/l*1e3;return{path:e,length:r,group:i,circles:h,trailCount:u,trailSpacingPx:this.TRAIL_SPACING_PX,active:!1,reverse:!1,speed:l,fadeDuration:this.BASE_FADE_MS,travelDuration:b,globalCycleDuration:0,idleDuration:0,cycleStart:null,globalAlpha:1}},configureGlobalTiming(){const e=Object.values(this.pulses);if(e.length===0)return;const s=Math.max(...e.map(r=>r.travelDuration))+this.BASE_FADE_MS;e.forEach(r=>{r.globalCycleDuration=s,r.fadeDuration=this.BASE_FADE_MS;const i=r.travelDuration+r.fadeDuration;r.idleDuration=Math.max(0,s-i)})},animatePulsesFrame(e){Object.values(this.pulses).forEach(t=>{if(!t.active){t.circles.forEach(l=>l.setAttribute("visibility","hidden"));return}t.cycleStart===null&&(t.cycleStart=e);const r=(e-t.cycleStart)%t.globalCycleDuration;let i,a="idle";if(r<t.travelDuration)a="travel",i=r/t.travelDuration,t.globalAlpha=1;else if(r<t.travelDuration+t.fadeDuration){a="fade",i=1;const l=r-t.travelDuration;t.globalAlpha=Math.max(0,1-l/t.fadeDuration)}else a="idle",i=0,t.globalAlpha=0;if(a==="idle"||t.globalAlpha<=.01){t.circles.forEach(l=>l.setAttribute("visibility","hidden"));return}const u=t.reverse?1-i:i,h=t.length*u;for(let l=0;l<t.trailCount;l++){const b=t.circles[l],d=l*t.trailSpacingPx,o=t.reverse?h+d:h-d;if(o<0||o>t.length){b.setAttribute("visibility","hidden");continue}const n=t.path.getPointAtLength(o);b.setAttribute("cx",n.x),b.setAttribute("cy",n.y),b.setAttribute("visibility","visible");const c=1-l/t.trailCount;b.setAttribute("fill-opacity",(c*t.globalAlpha).toFixed(3))}})},createLabelLines(e){const t="http://www.w3.org/2000/svg";Object.entries(this.labelPathsData).forEach(([s,r])=>{const i=document.createElementNS(t,"path");i.setAttribute("d",this.scalePath(r.d)),i.setAttribute("stroke",this.INACTIVE_ROUTE_COLOR),i.setAttribute("stroke-opacity","0.7"),i.setAttribute("stroke-width",this.LABEL_STROKE_WIDTH.toFixed(1)),i.setAttribute("fill","none"),e.appendChild(i);const a=i.getTotalLength(),u=i.getPointAtLength(0),h=i.getPointAtLength(a),l=u.y<=h.y?u:h,b=u.y<=h.y?h:u,d=Math.max(u.x,h.x)+this.LABEL_TEXT_OFFSET_X,o=document.createElementNS(t,"text");o.setAttribute("fill","#ffffff"),o.setAttribute("text-anchor","start"),o.setAttribute("font-size",this.LABEL_VALUE_FONT_SIZE.toFixed(1)),o.setAttribute("font-family","system-ui, -apple-system, sans-serif");const n=document.createElementNS(t,"text");n.setAttribute("fill","#7d7f82"),n.setAttribute("text-anchor","start"),n.setAttribute("font-size",this.LABEL_NAME_FONT_SIZE.toFixed(1)),n.setAttribute("font-family","system-ui, -apple-system, sans-serif"),n.setAttribute("letter-spacing",(1*this.scaleFactor).toFixed(1)),n.textContent=r.label||s.toUpperCase();const c=document.createElementNS(t,"text");if(c.setAttribute("fill",this.pulseColor),c.setAttribute("text-anchor","start"),c.setAttribute("font-size",this.LABEL_SUB_FONT_SIZE.toFixed(1)),c.setAttribute("font-family","system-ui, -apple-system, sans-serif"),c.setAttribute("display","none"),r.align==="top"){o.setAttribute("dominant-baseline","hanging"),n.setAttribute("dominant-baseline","hanging"),c.setAttribute("dominant-baseline","hanging");const f=l.y,A=f+this.LABEL_VALUE_FONT_SIZE+this.LABEL_VALUE_LABEL_GAP,L=A+this.LABEL_NAME_FONT_SIZE+this.LABEL_LABEL_SUB_GAP;o.setAttribute("x",d.toFixed(1)),o.setAttribute("y",f.toFixed(1)),n.setAttribute("x",d.toFixed(1)),n.setAttribute("y",A.toFixed(1)),c.setAttribute("x",d.toFixed(1)),c.setAttribute("y",L.toFixed(1))}else{n.setAttribute("dominant-baseline","auto"),o.setAttribute("dominant-baseline","auto"),c.setAttribute("dominant-baseline","hanging");const f=b.y,A=f-(this.LABEL_VALUE_LABEL_GAP+this.LABEL_NAME_FONT_SIZE),L=f+this.LABEL_LABEL_SUB_GAP;n.setAttribute("x",d.toFixed(1)),n.setAttribute("y",f.toFixed(1)),o.setAttribute("x",d.toFixed(1)),o.setAttribute("y",A.toFixed(1)),c.setAttribute("x",d.toFixed(1)),c.setAttribute("y",L.toFixed(1))}e.appendChild(o),e.appendChild(n),e.appendChild(c),this.labelLines[s]={path:i,valueEl:o,labelEl:n,subEl:c}})},setLineValue(e,t){const s=this.labelLines[e];s&&(s.valueEl.textContent=t)},setLineSubLabel(e,t){const s=this.labelLines[e];s&&(t==null||t===""?(s.subEl.textContent="",s.subEl.setAttribute("display","none")):(s.subEl.textContent=t,s.subEl.setAttribute("display","")))},getProperty(e){if(this.state&&this.state[e]!==void 0)return this.state[e];if(this.props&&this.props[e]!==void 0)return this.props[e]},setDynamicProperties(e){Object.keys(e).forEach(t=>{this.state&&this.$set(this.state,t,e[t])})}}},T={class:"ui-energy-overview-wrapper"},S={class:"canvas-wrapper"},y=["src"],I={ref:"overlay",preserveAspectRatio:"xMidYMid meet"};function P(e,t,s,r,i,a){return p.openBlock(),p.createElementBlock("div",T,[p.createElementVNode("div",S,[p.createElementVNode("img",{ref:"baseImage",src:a.imageUrl,alt:"House",onLoad:t[0]||(t[0]=(...u)=>a.onImageLoad&&a.onImageLoad(...u))},null,40,y),(p.openBlock(),p.createElementBlock("svg",I,[...t[1]||(t[1]=[p.createElementVNode("defs",null,[p.createElementVNode("filter",{id:"pulseBlur",x:"-20%",y:"-20%",width:"140%",height:"140%"},[p.createElementVNode("feGaussianBlur",{stdDeviation:"2.0"})])],-1)])],512))])])}const F=_(v,[["render",P],["__scopeId","data-v-811c0ea4"]]);E.UIEnergyOverview=F,Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});
