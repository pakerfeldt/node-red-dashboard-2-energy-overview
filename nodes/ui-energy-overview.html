<script type="text/javascript">
    RED.nodes.registerType('ui-energy-overview', {
        category: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.label.category'),
        color: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.colors.light'),
        defaults: {
            name: { value: "" },
            group: { type: 'ui-group', required: true },
            order: { value: 0 },
            width: {
                value: 6,
                validate: function (v) {
                    const width = v || 0
                    const currentGroup = $('#node-input-group').val() || this.group
                    const groupNode = RED.nodes.node(currentGroup)
                    const valid = !groupNode || +width <= +groupNode.width
                    $('#node-input-size').toggleClass('input-error', !valid)
                    return valid
                }
            },
            height: { value: 6 },
            pulseColor: { value: "#4dcbbf" },
            image: { value: "" },
            customPaths: { 
                value: "",
                validate: function(v) {
                    if (!v || v.trim() === "") return true
                    try {
                        const parsed = JSON.parse(v)
                        return parsed.energyPaths && parsed.labels
                    } catch (e) {
                        return false
                    }
                }
            },
            animationSpeed: { 
                value: 150,
                validate: function(v) {
                    if (v === '' || v === undefined || v === null) return true;
                    const num = parseFloat(v);
                    return !isNaN(num) && num >= 50 && num <= 500;
                }
            },
            trailLength: { 
                value: 120,
                validate: function(v) {
                    if (v === '' || v === undefined || v === null) return true;
                    const num = parseFloat(v);
                    return !isNaN(num) && num >= 50 && num <= 300;
                }
            },
            trailSpacing: { 
                value: 4,
                validate: function(v) {
                    if (v === '' || v === undefined || v === null) return true;
                    const num = parseFloat(v);
                    return !isNaN(num) && num >= 1 && num <= 20;
                }
            },
            fadeTime: { 
                value: 1600,
                validate: function(v) {
                    if (v === '' || v === undefined || v === null) return true;
                    const num = parseFloat(v);
                    return !isNaN(num) && num >= 500 && num <= 3000;
                }
            },
            strokeWidth: { 
                value: 3.2,
                validate: function(v) {
                    if (v === '' || v === undefined || v === null) return true;
                    const num = parseFloat(v);
                    return !isNaN(num) && num >= 1 && num <= 10;
                }
            },
            labelFontSizes: { 
                value: JSON.stringify({ 
                    value: 42, 
                    name: 32, 
                    sub: 32 
                })
            },
            labelSpacing: { 
                value: JSON.stringify({ 
                    textOffset: 16, 
                    valueLabelGap: 8, 
                    labelSubGap: 10 
                })
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-bolt",
        paletteLabel: "energy overview",
        label: function() {
            return this.name || "energy overview";
        },
        oneditprepare: function () {
            $('#node-input-size').elementSizer({
                width: '#node-input-width',
                height: '#node-input-height',
                group: '#node-input-group'
            });

            const $customPaths = $('#node-input-customPaths');
            const $validationStatus = $('#custom-paths-validation');
            
            function validateCustomPaths() {
                const value = $customPaths.val().trim();
                if (!value) {
                    $validationStatus.html('<span style="color: #888;">Using default paths</span>');
                    $customPaths.removeClass('input-error');
                    return;
                }
                try {
                    const parsed = JSON.parse(value);
                    if (parsed.energyPaths && parsed.labels) {
                        const pathCount = Object.keys(parsed.energyPaths).length;
                        const labelCount = Object.keys(parsed.labels).length;
                        $validationStatus.html('<span style="color: #5a5;">Valid JSON: ' + pathCount + ' energy paths, ' + labelCount + ' labels</span>');
                        $customPaths.removeClass('input-error');
                    } else {
                        $validationStatus.html('<span style="color: #d55;">Missing required fields: energyPaths and/or labels</span>');
                        $customPaths.addClass('input-error');
                    }
                } catch (e) {
                    $validationStatus.html('<span style="color: #d55;">Invalid JSON: ' + e.message + '</span>');
                    $customPaths.addClass('input-error');
                }
            }
            
            $customPaths.on('input', validateCustomPaths);
            validateCustomPaths();

            // Animation settings toggle
            $('#animation-settings-toggle').on('click', function(e) {
                e.preventDefault();
                const $container = $('#animation-settings-container');
                const $caret = $('#animation-settings-caret');
                $container.slideToggle(200);
                $caret.toggleClass('fa-caret-right fa-caret-down');
            });

            // Animation settings validation with visual feedback
            const animationFields = [
                { id: 'node-input-animationSpeed', min: 50, max: 500, defaultValue: 150 },
                { id: 'node-input-trailLength', min: 50, max: 300, defaultValue: 120 },
                { id: 'node-input-trailSpacing', min: 1, max: 20, defaultValue: 4 },
                { id: 'node-input-fadeTime', min: 500, max: 3000, defaultValue: 1600 },
                { id: 'node-input-strokeWidth', min: 1, max: 10, defaultValue: 3.2 }
            ];

            animationFields.forEach(function(field) {
                const $input = $('#' + field.id);
                // Initialize with default value if empty
                if ($input.val() === '' || $input.val() === undefined) {
                    $input.val(field.defaultValue);
                }
                $input.on('input change', function() {
                    const val = parseFloat($input.val());
                    const valid = !isNaN(val) && val >= field.min && val <= field.max;
                    $input.toggleClass('input-error', !valid);
                });
                // Trigger initial validation
                $input.trigger('change');
            });
        }
    });
</script>

<script type="text/html" data-template-name="ui-energy-overview">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-pulseColor"><i class="fa fa-paint-brush"></i> Pulse Color</label>
        <input type="color" id="node-input-pulseColor" style="width: 100px;">
    </div>
    <div class="form-row">
        <label for="node-input-image"><i class="fa fa-image"></i> Image URL</label>
        <input type="text" id="node-input-image" placeholder="Leave empty for default image">
    </div>
    <div class="form-row">
        <label for="node-input-customPaths"><i class="fa fa-code"></i> Custom Paths</label>
        <textarea id="node-input-customPaths" rows="8" style="width: 70%; font-family: monospace; font-size: 12px;" placeholder="Paste JSON from path tracer tool here (leave empty for default paths)"></textarea>
        <div id="custom-paths-validation" style="margin-top: 4px; font-size: 11px;"></div>
        <div class="form-tips" style="margin-top: 8px;">
            <b>Tip:</b> Use the <a href="https://pakerfeldt.github.io/node-red-dashboard-2-energy-overview/energy-path-tracer.html" target="_blank">Path Tracer Tool</a> 
            to generate custom path configurations for your own house image.
        </div>
    </div>
    
    <!-- Animation Settings (collapsible) -->
    <div class="form-row">
        <a href="#" id="animation-settings-toggle" style="text-decoration: none;">
            <i class="fa fa-caret-right" id="animation-settings-caret"></i> <span>Animation Settings</span>
        </a>
    </div>
    <div id="animation-settings-container" style="display: none; margin-left: 20px;">
        <div class="form-row">
            <label for="node-input-animationSpeed"><i class="fa fa-tachometer"></i> Speed (px/sec)</label>
            <input type="number" id="node-input-animationSpeed" style="width: 100px;" min="50" max="500" step="10">
        </div>
        <div class="form-row">
            <label for="node-input-trailLength"><i class="fa fa-arrows-h"></i> Trail Length (px)</label>
            <input type="number" id="node-input-trailLength" style="width: 100px;" min="50" max="300" step="10">
        </div>
        <div class="form-row">
            <label for="node-input-trailSpacing"><i class="fa fa-circle-o"></i> Trail Spacing (px)</label>
            <input type="number" id="node-input-trailSpacing" style="width: 100px;" min="1" max="20" step="1">
        </div>
        <div class="form-row">
            <label for="node-input-fadeTime"><i class="fa fa-clock-o"></i> Fade Time (ms)</label>
            <input type="number" id="node-input-fadeTime" style="width: 100px;" min="500" max="3000" step="100">
        </div>
        <div class="form-row">
            <label for="node-input-strokeWidth"><i class="fa fa-paint-brush"></i> Stroke Width</label>
            <input type="number" id="node-input-strokeWidth" style="width: 100px;" min="1" max="10" step="0.1">
        </div>
    </div>
</script>

<script type="text/html" data-help-name="ui-energy-overview">
    <p>An energy flow visualization widget for Node-RED Dashboard 2.0.</p>
    
    <h3>Inputs</h3>
    <p>The node accepts <code>msg.payload</code> with the following structure:</p>
    
    <h4>Payload Structure</h4>
    <pre>
msg.payload = {
    routes: {
        solarToInverter: true,
        inverterToHome: true,
        gridToInverter: false
    },
    labels: {
        solar: { value: "3.2 kW", sublabel: "Producing" },
        home: { value: "1.5 kW", sublabel: "Consuming" }
    }
}
    </pre>
    
    <h4>Route Controls (boolean)</h4>
    <p>Set <code>msg.payload.routes</code> to control energy flow animations:</p>
    <ul>
        <li><code>solarToInverter</code> - Enable/disable solar to inverter flow</li>
        <li><code>inverterToHome</code> - Enable/disable inverter to home flow</li>
        <li><code>inverterToGrid</code> - Enable/disable inverter to grid flow (export)</li>
        <li><code>gridToInverter</code> - Enable/disable grid to inverter flow (import)</li>
        <li><code>inverterToBattery</code> - Enable/disable inverter to battery flow (charging)</li>
        <li><code>batteryToInverter</code> - Enable/disable battery to inverter flow (discharging)</li>
        <li><code>inverterToCar</code> - Enable/disable inverter to car flow (EV charging)</li>
        <li><code>carToInverter</code> - Enable/disable car to inverter flow (V2H/V2G)</li>
    </ul>
    
    <h4>Labels</h4>
    <p>Set <code>msg.payload.labels</code> to update values and sublabels:</p>
    <pre>
msg.payload.labels = {
    solar: { value: "3.2 kW", sublabel: "Producing" },
    home: { value: "1.5 kW", sublabel: "Consuming" },
    grid: { value: "0.8 kW", sublabel: "Exporting" },
    battery: { value: "85%", sublabel: "Charging" },
    car: { value: "7.4 kW", sublabel: "Charging" }
}
    </pre>
    <p>Labels are merged with existing values, so you can update individual labels without resending all of them.</p>
    
    <h4>Reset State</h4>
    <p>Use <code>msg.reset</code> to clear all stored routes and labels before applying new values:</p>
    <pre>
msg.reset = true;  // Any value works, just needs to be defined
msg.payload = {
    routes: { solarToInverter: true },
    labels: { solar: { value: "5 kW" } }
};
    </pre>
    <p>This clears the existing state first, then applies only the values in the current message. Without <code>msg.reset</code>, routes and labels are merged with existing state.</p>
    
    <h4>Dynamic Properties</h4>
    <p>Use <code>msg.ui_update</code> to dynamically update widget configuration:</p>
    <ul>
        <li><code>msg.ui_update.pulseColor</code> - Change the pulse animation color</li>
        <li><code>msg.ui_update.image</code> - Change the background image URL</li>
        <li><code>msg.ui_update.animationSpeed</code> - Change animation speed (px/sec, 50-500)</li>
        <li><code>msg.ui_update.trailLength</code> - Change pulse trail length (px, 50-300)</li>
        <li><code>msg.ui_update.trailSpacing</code> - Change spacing between trail dots (px, 1-20)</li>
        <li><code>msg.ui_update.fadeTime</code> - Change fade out duration (ms, 500-3000)</li>
        <li><code>msg.ui_update.strokeWidth</code> - Change pulse stroke width (1-10)</li>
    </ul>
    
    <h3>Custom Paths</h3>
    <p>The default house image works out of the box, but if you want to use your own house image or floor plan, you'll need to create custom paths. Custom paths define where the energy flow animations and labels are positioned on your image.</p>
    <p>Use the <a href="https://pakerfeldt.github.io/node-red-dashboard-2-energy-overview/energy-path-tracer.html" target="_blank">Path Tracer Tool</a> to visually draw paths on your custom image, then copy the generated JSON into the "Custom Paths" field.</p>
    <p>Expected JSON format:</p>
    <pre>
{
  "energyPaths": {
    "solarToInverter": "M 427 295 L 484 332 L 484 533",
    "inverterToHome": ["M 513 532 L 513 445 L 808 451", "M 513 532 L 966 455"],
    "inverterToGrid": "M 451 631 L 401 631 L 403 821",
    "inverterToBattery": "M 499 649 L 499 748 L 594 742",
    "inverterToCar": "M 451 604 L 389 608 L 253 654"
  },
  "labels": {
    "solar": { "position": "M 608 41 L 608 300", "align": "top" },
    "home": { "position": "M 776 41 L 776 445", "align": "top" },
    "grid": { "position": "M 448 850 L 448 921", "align": "bottom" },
    "battery": { "position": "M 643 772 L 643 921", "align": "bottom" },
    "car": { "position": "M 103 820 L 103 921", "align": "bottom" }
  }
}
    </pre>
    
    <h3>Example Flow</h3>
    <pre>
// Enable solar production flowing to home
msg.payload = {
    routes: {
        solarToInverter: true,
        inverterToHome: true
    },
    labels: {
        solar: { value: "5.2 kW" },
        home: { value: "2.1 kW" }
    }
};
return msg;
    </pre>
</script>
